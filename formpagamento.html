<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento com Stripe</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .product-list {
            margin-bottom: 20px;
        }
        .product-list ul {
            list-style-type: none;
            padding: 0;
        }
        .product-list li {
            margin-bottom: 10px;
        }
        .price {
            font-weight: bold;
        }
        #payment-form {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h2>Resumo da Compra</h2>

    <div class="product-list">
        <h3>Itens no carrinho:</h3>
        <ul id="cart-items">
            <!-- Itens do carrinho serão carregados aqui -->
        </ul>
        <p id="cart-total">Total: R$ 0.00</p>
    </div>

    <h2>Escolha sua forma de pagamento</h2>
    <form id="payment-form">
        <div id="card-element">
            <!-- Stripe Card Element será inserido aqui -->
        </div>

        <button type="submit">Pagar com Cartão de Crédito</button>
    </form>

    <h3>Ou pague via PIX</h3>
    <button id="pay-pix" style="margin-top: 10px;">Pagar com PIX</button>
    <div id="pix-info" style="display: none;">
        <p>Faça o pagamento para o e-mail: <strong>guilherme8876sk@gmail.com</strong></p>
        <p><em>Após realizar o pagamento, envie o comprovante para confirmação.</em></p>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        const stripe = Stripe('pk_live_51...');  // Substitua pela sua chave pública real
        const elements = stripe.elements();
        const card = elements.create('card'); // Cria o campo para o cartão de crédito
        card.mount('#card-element'); // Insere o campo no DOM

        // Recupera o carrinho do localStorage
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const cartTotal = JSON.parse(localStorage.getItem('cartTotal')) || 0;

        // Exibe os itens do carrinho no formulário
        const cartItemsContainer = document.getElementById('cart-items');
        cart.forEach(item => {
            const cartItemElement = document.createElement('li');
            cartItemElement.innerHTML = `${item.name} - ${item.quantity}x - R$ ${(item.price * item.quantity).toFixed(2)}`;
            cartItemsContainer.appendChild(cartItemElement);
        });

        // Exibe o total no final
        document.getElementById('cart-total').textContent = `Total: R$ ${cartTotal.toFixed(2)}`;

        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // Previne o comportamento padrão do formulário

            const {token, error} = await stripe.createToken(card); // Cria o token com o Stripe

            if (error) {
                console.error(error); // Em caso de erro, loga no console
                alert('Erro no pagamento!');
            } else {
                const response = await fetch('/pagamento', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        amount: cartTotal * 100, // valor em centavos
                    }),
                });

                const result = await response.json();
                if (result.success) {
                    alert('Pagamento realizado com sucesso!');
                } else {
                    alert('Erro: ' + result.error);
                }
            }
        });

        // Função para exibir a opção de pagamento via PIX
        document.getElementById('pay-pix').addEventListener('click', () => {
            // Exibe as instruções para pagamento via PIX (chave de e-mail)
            document.getElementById('pix-info').style.display = 'block';
            alert("Pagamento via PIX selecionado! Use a chave de e-mail para fazer o pagamento.");
        });
    </script>

</body>
</html>

